@page "/accountsettings"
@using AplikacjaInzynierska.Authentication
@using AplikacjaInzynierska.Services
@using AplikacjaInzynierska.Data
@inject GroupUserService groupUserService
@inject LogsService logsService
@inject IJSRuntime js
@inject AuthenticationStateProvider authStateProvider
@using System.Security.Claims
@inject NavigationManager navManager
@using System.Security.Cryptography;

<EditForm Model="model">
    <div class="row justify-content-md-center">
        <div class="col-5 border p-3 mb-2 bg-light text-dark text-center rounded">
            <p class="fs-4 fw-bold">
                Ustawienia konta
            </p>
            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Imię</label>
                    <InputText class="form-control" maxlength="40" @bind-Value="model.name" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Nazwisko</label>
                <InputText class="form-control" maxlength="150" @bind-Value="model.surname" />
            </div>

           <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Email</label>
                <InputText class="form-control" maxlength="150" @bind-Value="model.email" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Stare hasło</label>
                <InputText type="password" class="form-control" @bind-Value="model.password" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Nowe hasło</label>
                <InputText type="password" class="form-control" @bind-Value="model.newpassword" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Powtórz nowe hasło</label>
                <InputText type="password" class="form-control" @bind-Value="model.repeatpassword" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Data urodzenia</label>
                <InputDate class="form-control" @bind-Value="model.date_birthday" />
            </div>

            <!-- add file -->
            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text">Zdjęcie profilowe</label>
                <InputFile class="form-control" />
            </div>

             <button type="button" class="btn btn-success" @onclick="Authenticate">Zapisz</button>
        </div>
    </div>
    
    @*<p>
        <img src="images/user.jpg" zdjecie"/>
        <InputFile/>
    </p>

    <button>Edytuj dane</button>*@
</EditForm>

@code {

    Model model = new Model();

    class Model
    {
        public string? name { get; set; }
        public string? surname { get; set; }
        public DateTime date_birthday { get; set; }
        public string? email { get; set; }
        public string? password { get; set; } = "";
        public string? newpassword { get; set; } = "";
        public string? repeatpassword { get; set; } = "";
    }

    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { get; set; }

    public System.Collections.Generic.IList<GroupUserClass> userr;
    LogsClass log = new LogsClass();

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationState;
        var claimEmail = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value;
        var userInformation = groupUserService.GetByUserEmail(claimEmail);

        model.name = userInformation.name;
        model.surname = userInformation.surname;
        model.email = userInformation.email;
        model.date_birthday = userInformation.date_birthday;
    }

    void Authenticate()
    {
        var userAccount = groupUserService.GetByUserEmail(model.email);

        var dateNow = DateTime.Now.ToString("yyyy-MM-dd");
        var timeNow = DateTime.Now.ToString("HH:mm:ss");

        log.date = DateTime.Parse(dateNow).ToUniversalTime().AddDays(1);
        log.time = TimeOnly.Parse(timeNow);
        log.id_user = userAccount.id_user;

            if (userAccount == null)
            {
                log.event_log = "failed update account. there is an account with the address: " + model.email;
                logsService.AddNewEvent(log);
                js.InvokeVoidAsync("alert", "Konto pod tym adresem email już istnieje!");
            }
            else
            {
                

                if (model.password == "")
                {
                    GroupUserClass gu = new GroupUserClass();

                    gu.name = model.name;
                    gu.surname = model.surname;
                    gu.date_birthday = model.date_birthday;
                    gu.email = model.email;
                    string newpassword = null;

                    groupUserService.EditUser(gu, newpassword);
                    log.event_log = "successful update account without password";
                    logsService.AddNewEvent(log);
                    js.InvokeVoidAsync("alert", "Pomyślny update!");
                    return;
                }
                else
                {
                    var sha256 = SHA256.Create();
                    var passwordBytes = System.Text.Encoding.UTF8.GetBytes(model.password);
                    var passwordHash = sha256.ComputeHash(passwordBytes);
                    string passwordHashed = BitConverter.ToString(passwordHash).Replace("-", "").ToLower();

                    if (passwordHashed == userAccount.password)
                    {
                        if ((model.newpassword != "") && (model.newpassword == model.repeatpassword))
                        {
                            GroupUserClass gu = new GroupUserClass();

                            var newPasswordBytes = System.Text.Encoding.UTF8.GetBytes(model.newpassword);
                            var newPasswordHash = sha256.ComputeHash(newPasswordBytes);
                            string newPasswordHashed = BitConverter.ToString(newPasswordHash).Replace("-", "").ToLower();

                            gu.name = model.name;
                            gu.surname = model.surname;
                            gu.date_birthday = model.date_birthday;
                            gu.email = model.email;
                            gu.password = passwordHashed;
                            string newpassword = newPasswordHashed;

                            groupUserService.EditUser(gu, newpassword);
                            model.password = "";
                            model.newpassword = "";
                            model.repeatpassword = "";

                            
                            log.event_log = "successful update account with password";
                            logsService.AddNewEvent(log);

                            js.InvokeVoidAsync("alert", "Pomyślny update z hasłem!");
                            return;
                        }
                        else
                        {
                            js.InvokeVoidAsync("alert", "Nowe hasła nie są takie same!");
                            model.password = "";
                            model.newpassword = "";
                            model.repeatpassword = "";
                            log.event_log = "failed update account with password";
                            logsService.AddNewEvent(log);
                            return;
                        }
                        
                    }
                    else
                    {
                        js.InvokeVoidAsync("alert", "Stare hasło podano nieprawidłowe!");
                        model.password = "";
                        model.newpassword = "";
                        model.repeatpassword = "";
                        log.event_log = "failed update account with password";
                        logsService.AddNewEvent(log);
                        return;
                    }
                }
        }
        
    }

}
