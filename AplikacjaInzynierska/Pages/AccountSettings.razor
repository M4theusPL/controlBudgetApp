@page "/accountsettings"
@using AplikacjaInzynierska.Authentication
@using AplikacjaInzynierska.Services
@using AplikacjaInzynierska.Data
@attribute [Authorize(Roles = "Admin, User")]
@inject UsersService userService
@inject LogsService logsService
@inject IJSRuntime js
@inject AuthenticationStateProvider authStateProvider
@using System.Security.Claims
@inject NavigationManager navManager
@using System.Security.Cryptography;

<PageTitle>controlBudgetApp - Ustawienia konta</PageTitle>

<EditForm Model="model">
    <div class="row justify-content-md-center">
        <div class="col-5 border p-3 mb-2 bg-light text-dark text-center rounded">
            <p class="fs-4 fw-bold">
                Ustawienia konta
            </p>
            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Imię</label>
                    <InputText class="form-control" maxlength="40" @bind-Value="model.name" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Nazwisko</label>
                <InputText class="form-control" maxlength="150" @bind-Value="model.surname" />
            </div>

           <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Email</label>
                <InputText class="form-control" maxlength="150" @bind-Value="model.email" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Stare hasło</label>
                <InputText type="password" class="form-control" @bind-Value="model.password" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Nowe hasło</label>
                <InputText type="password" class="form-control" @bind-Value="model.newpassword" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Powtórz nowe hasło</label>
                <InputText type="password" class="form-control" @bind-Value="model.repeatpassword" />
            </div>

            <div class="input-group mb-3">
                <label class="col-sm-5 input-group-text" >Data urodzenia</label>
                <InputDate class="form-control" @bind-Value="model.date_birthday" />
            </div>

             <button type="button" class="btn btn-success" @onclick="Authenticate">Zapisz</button>
        </div>
    </div>
</EditForm>

@code {

    Model model = new Model();

    class Model
    {
        public string? name { get; set; }
        public string? surname { get; set; }
        public DateTime date_birthday { get; set; }
        public string? email { get; set; }
        public string? password { get; set; } = "";
        public string? newpassword { get; set; } = "";
        public string? repeatpassword { get; set; } = "";
    }

    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { get; set; }

    public System.Collections.Generic.IList<UsersClass> userr;
    LogsClass log = new LogsClass();

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationState;
        var claimEmail = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value;
        var userInformation = userService.GetByUserEmail(claimEmail);

        model.name = userInformation.name;
        model.surname = userInformation.surname;
        model.email = userInformation.email;
        model.date_birthday = userInformation.date_birthday;
    }

    async Task Authenticate()
    {
        var authState = await authenticationState;
        var claimEmail = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value;
        var userInformation = userService.GetByUserEmail(claimEmail);
        var checkEmail = userService.CheckEmail(model.email);

        var dateNow = DateTime.Now.ToString("yyyy-MM-dd");
        var timeNow = DateTime.Now.ToString("HH:mm:ss");

        log.date = DateTime.Parse(dateNow).ToUniversalTime().AddDays(1);
        log.time = TimeOnly.Parse(timeNow);
        log.id_user = userInformation.id_user;

        if (checkEmail == null)
        {
            log.event_log = "failed update account. there is an account with the address: " + model.email;
            logsService.AddNewEvent(log);
            log = new LogsClass();
            js.InvokeVoidAsync("alert", "Konto pod tym adresem email już istnieje!");
        }
        else if (checkEmail == true && userInformation.email != model.email)
        {
            log.event_log = "failed update account. there is an account with the address: " + model.email;
            logsService.AddNewEvent(log);
            log = new LogsClass();
            js.InvokeVoidAsync("alert", "Konto pod tym adresem email już istnieje!");
        }
        else
        {
            if (model.password == "")
            {
                UsersClass uc = new UsersClass();
                uc.name = model.name;
                uc.surname = model.surname;
                uc.date_birthday = model.date_birthday.ToUniversalTime();
                uc.email = model.email;
                string newpassword = null;

                userService.EditUser(uc, userInformation.id_user, newpassword);
                log.event_log = "successful update account without password";
                logsService.AddNewEvent(log);
                log = new LogsClass();
                js.InvokeVoidAsync("alert", "Pomyślna aktualizacja konta!");
            }
            else
            {
                    var sha256 = SHA256.Create();
                    var passwordBytes = System.Text.Encoding.UTF8.GetBytes(model.password);
                    var passwordHash = sha256.ComputeHash(passwordBytes);
                    string passwordHashed = BitConverter.ToString(passwordHash).Replace("-", "").ToLower();

                    if (passwordHashed == userInformation.password)
                    {
                        if ((model.newpassword != "") && (model.newpassword == model.repeatpassword))
                        {
                            UsersClass gu = new UsersClass();

                            var newPasswordBytes = System.Text.Encoding.UTF8.GetBytes(model.newpassword);
                            var newPasswordHash = sha256.ComputeHash(newPasswordBytes);
                            string newPasswordHashed = BitConverter.ToString(newPasswordHash).Replace("-", "").ToLower();

                            gu.name = model.name;
                            gu.surname = model.surname;
                            gu.date_birthday = model.date_birthday;
                            gu.email = model.email;
                            gu.password = passwordHashed;
                            string newpassword = newPasswordHashed;

                        userService.EditUser(gu, userInformation.id_user, newpassword);
                            model.password = "";
                            model.newpassword = "";
                            model.repeatpassword = "";

                            
                            log.event_log = "successful update account with password";
                            logsService.AddNewEvent(log);
                        log = new LogsClass();
                            js.InvokeVoidAsync("alert", "Pomyślna aktualizacja konta!");
                            js.InvokeVoidAsync("alert", "Proszę o zalogowanie się ponownie.");
                            var customAuthStateProvider = (CustomAuthenticationStateProvider)authStateProvider;
                            await customAuthStateProvider.UpdateAuthenticationState(null);
                            navManager.NavigateTo("/login", true);
                        }
                        else
                        {
                            js.InvokeVoidAsync("alert", "Nowe hasła nie są takie same!");
                            model.password = "";
                            model.newpassword = "";
                            model.repeatpassword = "";
                            log.event_log = "failed update account with password";
                        
                            logsService.AddNewEvent(log);
                        log = new LogsClass();
                        }
                        
                    }
                    else
                    {
                        js.InvokeVoidAsync("alert", "Stare hasło podano nieprawidłowe!");
                        model.password = "";
                        model.newpassword = "";
                        model.repeatpassword = "";
                        log.event_log = "failed update account with password";
                   
                        logsService.AddNewEvent(log);
                    log = new LogsClass();
                    }
                }
            if (claimEmail != model.email)
            {
                js.InvokeVoidAsync("alert", "Proszę o zalogowanie się ponownie.");
                var customAuthStateProvider = (CustomAuthenticationStateProvider)authStateProvider;
                await customAuthStateProvider.UpdateAuthenticationState(null);
                navManager.NavigateTo("/login", true);
            }
        }
        
    }

}
