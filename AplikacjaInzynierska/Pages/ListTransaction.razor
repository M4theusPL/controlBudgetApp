@page "/listtransaction"
@using AplikacjaInzynierska.Data;
@using AplikacjaInzynierska.Services;
@inject TransactionService transactionService
@inherits OwningComponentBase<TransactionService>
@attribute [Authorize(Roles = "Admin")]
@inject AuthenticationStateProvider authStateProvider
@using System.Security.Claims;
@inject GroupUserService groupUserService
@using Microsoft.JSInterop
@using iTextSharp.text;
@using iTextSharp.text.pdf;
@using System.IO;
@using Microsoft.AspNetCore.Http;
@using Microsoft.AspNetCore.Mvc;
@inject IJSRuntime JSRuntime

@if (trans == null)
{
    <div class="row justify-content-md-center text-center">
        <p class="fs-4 fw-bold">Brak transakcji. Proszę dodać transakcje.</p>
    </div>
} 
else
{
    <div class="row justify-content-md-center text-center">
        <p class="fs-4 fw-bold">Lista transakcji</p>
        <div class="col-11 border p-3 mb-2 bg-light text-dark rounded">
                <div class="row justify-content-md-center">
                    <div class="col-5 mb-2 bg-light text-dark text-center rounded">
                       <EditForm Model="filter">
                        <div class="input-group mb-3">
                            <label class="col-sm-5 input-group-text" >Wyszukiwana fraza</label>
                            <input type="text" class="form-control" @bind="SearchedText" @bind:event="oninput" @onchange="@NameChanged" /> 
                        </div>
                        
                            Sortuj od
                            <select Id="CountryList" class="form-group" @bind="SelectedValue" @bind:event="oninput" @onchange="@NameChanged">
                                @foreach (var item in Countries)
                                {
                                    <option value="@item.IdFilter">@item.Title</option>
                                }
                            </select>
                        </EditForm>
                        <button onclick="@PDFGenerate">PDF</button>
                    </div>
                </div>
                         
                <table class="table table-striped table-hover">
                    <thead>
                        <tr class="fw-bold">
                            <td>#</td>
                            <td>Nazwa</td>
                            <td>Opis</td>
                            <td>Kwota</td>
                            <td>Data transakcji</td>
                            <td>Podgląd</td>
                        </tr>
                    </thead>

                    <tbody>
                    @foreach (var trans in trans)
                        {
                            <tr>
                                <td>@trans.id_user_transaction</td>
                                <td>@trans.name_transaction</td>
                                <td>@trans.description</td>
                                <td>@trans.amount</td>
                                <td>@trans.date_transaction.ToString("yyyy-MM-dd")</td>
                                <td>
                                    <a class="nav-link" href="/transaction/@trans.id_user_transaction">
                                        <span class="material-icons" aria-hidden="true">search</span>
                                    </a>
                                </td>

                            </tr>
                        }
                    </tbody>
                </table>
        </div>
    </div>
}

@code {

    private class Transaction
    {
        public int id { get; set; }
        public string? name { get; set; }
        public string? description { get; set; }
        public double amount { get; set; }
        public string? date_transaction { get; set; }
    }

    private string SearchedText { get; set; } = "";

    public Filter filter = new Filter();
    public int SelectedValue { get; set; } = 1;
    public int sorting = 1;

    public class Filter
    {
        public int IdFilter { get; set; }
        public string Title { get; set; }
    }
    public List<Filter> Countries { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { get; set; }

    public System.Collections.Generic.IList<TransactionsClass> trans;

    public async Task<byte[]> PDFGenerate()
    {
        var authState = await authenticationState;
        var claimIdUser = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
        var claimEmail = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value;
        var userInformation = groupUserService.GetByUserEmail(claimEmail);
        using (var stream = new MemoryStream())
        {
            var document = new Document();
            var writer = PdfWriter.GetInstance(document, stream);
            DateTime dateNow = DateTime.Now.ToUniversalTime();
            document.Open();

            Paragraph paragraph = new Paragraph("NAZWA APLIKACJI", new Font(Font.HELVETICA, 21, Font.BOLD));
            paragraph.Alignment = Element.ALIGN_LEFT;
            document.Add(paragraph);
            document.Add(new Paragraph(" "));

            paragraph = new Paragraph("Raport z dnia " + dateNow.ToString("yyyy-MM-dd"), new Font(Font.HELVETICA, 18, Font.BOLD));
            paragraph.Alignment = Element.ALIGN_CENTER;
            document.Add(paragraph);
            document.Add(new Paragraph(" "));

            var table = new PdfPTable(5);
            float[] widths = new float[] { 40f, 100f, 150f, 75f, 110f };
            table.SetWidths(widths);

            PdfPCell cell = new PdfPCell(new Phrase("ID", new Font(Font.HELVETICA, 12, Font.BOLD)));
            table.AddCell(cell);

            cell = new PdfPCell(new Phrase("Nazwa", new Font(Font.HELVETICA, 12, Font.BOLD)));
            table.AddCell(cell);

            cell = new PdfPCell(new Phrase("Opis", new Font(Font.HELVETICA, 12, Font.BOLD)));
            table.AddCell(cell);

            cell = new PdfPCell(new Phrase("Kwota", new Font(Font.HELVETICA, 12, Font.BOLD)));
            table.AddCell(cell);

            cell = new PdfPCell(new Phrase("Data transakcji", new Font(Font.HELVETICA, 12, Font.BOLD)));
            table.AddCell(cell);

            foreach (var item in trans)
            {
                table.AddCell(item.id_user_transaction.ToString());
                table.AddCell(item.name_transaction);
                table.AddCell(item.description);
                table.AddCell(item.amount.ToString());
                table.AddCell(item.date_transaction.ToString("yyyy-MM-dd"));
            }

            document.Add(table);
            document.Close();
            var fileBytes = stream.ToArray();

            await JSRuntime.InvokeAsync<string>("ShowPDF", Convert.ToBase64String(fileBytes));
            return stream.ToArray();
        }
        
    }

    private async Task NameChanged(ChangeEventArgs args)
    {
        var authState = await authenticationState;
        var claimEmail = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value;
        var userInformation = groupUserService.GetByUserEmail(claimEmail);

        switch (SelectedValue)
        {
            case 1:
                sorting = 1;
                break;
            case 2:
                sorting = 2;
                break;
            case 3:
                sorting = 3;
                break;
            case 4:
                sorting = 4;
                break;
            case 5:
                sorting = 5;
                break;
            case 6:
                sorting = 6;
                break;
            case 7:
                sorting = 7;
                break;
            case 8:
                sorting = 8;
                break;
            case 9:
                sorting = 9;
                break;
            case 10:
                sorting = 10;
                break;
        }
        await JSRuntime.InvokeAsync<object>("console.log", sorting);

        trans = Service.displayGroupSearchTransaction(userInformation.id_group, SearchedText, sorting);
    }

    protected override async Task OnInitializedAsync()
    {
        Countries = new List<Filter>()
        {
            new Filter{IdFilter = 1, Title = "ID rosnąco"},
            new Filter{IdFilter = 2, Title = "ID malejąco"},
            new Filter{IdFilter = 3, Title = "nazwy A-Z"},
            new Filter{IdFilter = 4, Title = "nazwy Z-A"},
            new Filter{IdFilter = 5, Title = "opisu A-Z"},
            new Filter{IdFilter = 6, Title = "opisu Z-A"},
            new Filter{IdFilter = 7, Title = "kwoty rosnąco"},
            new Filter{IdFilter = 8, Title = "kwoty malejąco"},
            new Filter{IdFilter = 9, Title = "daty transakcji najnowszej"},
            new Filter{IdFilter = 10, Title = "daty transakcji najstarszej"},
        };


        var authState = await authenticationState;
        var claimIdUser = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
        var claimEmail = authState.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value;
        var userInformation = groupUserService.GetByUserEmail(claimEmail);
        trans = null;
        if (userInformation.id_group == 0)
        {
            var userTransactions = transactionService.GetByUserTransactions(Int32.Parse(claimIdUser));
            if (userTransactions == null)
            {

                trans = null;
            }
            else
            {
                trans = Service.displayUserTransaction(Int32.Parse(claimIdUser));
            }
        }
        else
        {
            var groupTransactions = transactionService.GetByGroupTransactions(userInformation.id_group);
            if (groupTransactions == null)
            {

                trans = null;
            }
            else
            {
                if (SearchedText.Trim().Length > 0)
                {
                    trans = Service.displayGroupSearchTransaction(userInformation.id_group, SearchedText, sorting);
                }
                else 
                {
                    trans = Service.displayGroupTransaction(userInformation.id_group);
                }             
            }
        }
    }
   
}
